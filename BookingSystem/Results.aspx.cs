using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using BookingSystem.Models;

namespace BookingSystem
{
    public partial class Results : Page
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            if (!IsPostBack)
            {
                // Retrieve search parameters from query string
                string fromDate = Request.QueryString["fromDate"];
                string toDate = Request.QueryString["toDate"];
                int guests = int.Parse(Request.QueryString["guests"]);
                string roomType = Request.QueryString["roomType"];

                // Perform search and bind results to GridView
                BindSearchResults(fromDate, toDate, guests, roomType);
            }
        }

        private void BindSearchResults(string fromDate, string toDate, int guests, string roomType)
        {
            // Create a new instance of the database context
            var db = new fawltyTowersContext();

            // Build a LINQ query that retrieves the available hotel rooms
            var query = from room in db.Rooms
                        where room.Quality == roomType
                              && room.Beds >= guests
                              && !db.Reservations.Any(r =>
                                  r.RoomNumber == room.RoomNumber
                                  && r.StartDate < DateTime.Parse(toDate)
                                  && r.EndDate > DateTime.Parse(fromDate))
                        select room;

            // Execute the query and return the results
            var availableRooms = query.ToList();

            if (availableRooms.Count <= 0) {
                lblMessage.Text = "No rooms are available for the selected dates and criteria.";
            }

            // Bind results to GridView
            gridResults.DataSource = availableRooms;
            gridResults.DataBind();
        }

        protected void gridResults_RowCommand(object sender, GridViewCommandEventArgs e)
        {
            if (e.CommandName == "BookRoom")
            {
                // Get the selected room number and dates
                string roomNumber = e.CommandArgument.ToString();
                string fromDate = Request.QueryString["fromDate"];
                string toDate = Request.QueryString["toDate"];
                string userId = Session["UserId"] as string;

                // Book the room
                BookRoom(roomNumber, fromDate, toDate, userId);

                // Redirect to the booking confirmation page
                Response.Redirect("BookingConfirmation.aspx");
            }
        }

        protected void BookRoom(string roomNumber, string fromDate, string toDate, string userId)
        {
            using (var context = new fawltyTowersContext())
            {
                    var booking = new Reservations
                    {
                        //ReservationId = autogenerated
                        RoomNumber = int.Parse(roomNumber),
                        StartDate = DateTime.Parse(fromDate),
                        EndDate = DateTime.Parse(toDate),
                        GuestId = int.Parse(userId)
                    };

                    context.Reservations.Add(booking);
                    context.SaveChanges();

            }
        }

    }
}